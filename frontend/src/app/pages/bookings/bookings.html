<div class="container">
  <h1>Réservations – Dubai Conciergerie</h1>

  <!-- Formulaire -->
  <div class="card">
    <h2>Nouvelle réservation</h2>

    <div *ngIf="errorMessage" class="error">
      {{ errorMessage }}
    </div>
    <div *ngIf="successMessage" class="success">
      {{ successMessage }}
    </div>

    <div class="filters">
      <div class="form-inline">
        <label>Client</label>
        <input
          type="text"
          [(ngModel)]="filterClient"
          name="filterClient"
          placeholder="Nom ou email"
        />
      </div>

      <div class="form-inline">
        <label>Statut</label>
        <select [(ngModel)]="filterStatus" name="filterStatus">
          <option value="ALL">Tous</option>
          <option value="CONFIRMED">CONFIRMED</option>
          <option value="PENDING">PENDING</option>
          <option value="CANCELED">CANCELED</option>
        </select>
      </div>

      <div class="form-inline">
        <label>Arrivée du</label>
        <input
          type="date"
          [(ngModel)]="filterStartDate"
          name="filterStartDate"
        />
      </div>

      <div class="form-inline">
        <label>Arrivée au</label>
        <input
          type="date"
          [(ngModel)]="filterEndDate"
          name="filterEndDate"
        />
      </div>

      <button
        type="button"
        class="btn-reset"
        (click)="resetFilters()"
      >
        ⟲ Réinitialiser
      </button>

    </div>


    <form #bookingForm="ngForm" (ngSubmit)="createBooking()">
      <div class="form-group">
        <label>ID du logement (propertyId)</label>
        <input type="number"
               [(ngModel)]="newBooking.propertyId"
               name="propertyId"
               required />
      </div>

      <div class="form-group">
        <label>Nom du client (guestName)</label>
        <input type="text"
               [(ngModel)]="newBooking.guestName"
               name="guestName"
               required />
      </div>

      <div class="form-group">
        <label>Email du client (guestEmail)</label>
        <input type="email"
               [(ngModel)]="newBooking.guestEmail"
               name="guestEmail"
               required />
      </div>

      <div class="form-group">
        <label>Date d'arrivée (startDate)</label>
        <input type="date"
               [(ngModel)]="newBooking.startDate"
               name="startDate"
               [min]="todayString"
               required />
      </div>

      <div class="form-group">
        <label>Date de départ (endDate)</label>
        <input type="date"
               [(ngModel)]="newBooking.endDate"
               name="endDate"
               required />
      </div>

      <div class="form-group">
        <label>Prix total (totalPrice)</label>
        <input type="number"
               [(ngModel)]="newBooking.totalPrice"
               name="totalPrice"
               min="0"
               step="0.01"
               required />
      </div>

      <div class="form-group">
        <label>Statut</label>
        <select [(ngModel)]="newBooking.status" name="status">
          <option value="PENDING">PENDING</option>
          <option value="CONFIRMED">CONFIRMED</option>
          <option value="CANCELED">CANCELED</option>
        </select>
      </div>

      <button type="submit">Créer la réservation</button>
    </form>
  </div>

  <!-- Liste -->
  <div class="card">
    <h2>Liste des réservations</h2>

    <div *ngIf="loading">Chargement...</div>

    <table *ngIf="!loading && bookings.length > 0">
      <thead>
      <tr>
        <th>ID</th>
        <th>PropertyId</th>
        <th>Client</th>
        <th>Email</th>
        <th>Arrivée</th>
        <th>Départ</th>
        <th>Prix total</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let b of filteredBookings">

      <td>{{ b.id }}</td>
        <td>{{ b.propertyId }}</td>
        <td>{{ b.guestName }}</td>
        <td>{{ b.guestEmail }}</td>
        <!--  formatage -->
        <td>{{ b.startDate | date:'dd/MM/yyyy' }}</td>
        <td>{{ b.endDate   | date:'dd/MM/yyyy' }}</td>
        <td>{{ formatPrice(b.totalPrice) }} €</td>
        <td>
            <span [ngClass]="getStatusClass(b.status)">
              {{ b.status }}
            </span>
        </td>
        <td>
          <!-- Si la réservation n'est pas annulée -->
          <button
            type="button"
            *ngIf="b.status !== 'CANCELED'; else cancelledTpl"
            (click)="cancelBooking(b)"
          >
            Annuler
          </button>

          <!-- Template affiché quand status = CANCELED -->
          <ng-template #cancelledTpl>
            <button type="button" disabled>
              Annulé
            </button>
          </ng-template>
        </td>

      </tr>
      </tbody>
    </table>

    <div *ngIf="!loading && bookings.length === 0">
      Aucune réservation pour l’instant.
    </div>
  </div>
</div>
