<div class="container">
  <h1>R√©servations ‚Äì Dubai Conciergerie</h1>

  <!-- Formulaire -->
  <div class="card">
    <h2>Nouvelle r√©servation</h2>

    <div *ngIf="errorMessage" class="error">
      {{ errorMessage }}
    </div>
    <div *ngIf="successMessage" class="success">
      {{ successMessage }}
    </div>

    <!-- FILTRES -->
    <div class="filters">
      <div class="form-inline">
        <label>Client</label>
        <input
          type="text"
          [(ngModel)]="filterClient"
          name="filterClient"
          placeholder="Nom ou email"
        />
      </div>

      <div class="form-inline">
        <label>Statut</label>
        <select [(ngModel)]="filterStatus" name="filterStatus">
          <option value="ALL">Tous</option>
          <option value="CONFIRMED">CONFIRMED</option>
          <option value="PENDING">PENDING</option>
          <option value="CANCELED">CANCELED</option>
        </select>
      </div>

      <div class="form-inline">
        <label>Arriv√©e du</label>
        <input
          type="date"
          [(ngModel)]="filterStartDate"
          name="filterStartDate"
        />
      </div>

      <div class="form-inline">
        <label>Arriv√©e au</label>
        <input
          type="date"
          [(ngModel)]="filterEndDate"
          name="filterEndDate"
        />
      </div>

      <button
        type="button"
        class="btn-reset"
        (click)="resetFilters()"
      >
        ‚ü≤ R√©initialiser
      </button>
    </div>


    <div class="form-inline">
      <label>
        <input
          type="checkbox"
          [(ngModel)]="excludeCanceled"
          name="excludeCanceled"
        />
        Exclure les annulations
      </label>
    </div>

    <!-- FORMULAIRE DE CR√âATION -->
    <form #bookingForm="ngForm" (ngSubmit)="createBooking()">
      <div class="form-group">
        <label>ID du logement (propertyId)</label>
        <input type="number"
               [(ngModel)]="newBooking.propertyId"
               name="propertyId"
               (ngModelChange)="onPropertyChange()"
               required />
      </div>

      <div class="form-group">
        <label>Nom du client (guestName)</label>
        <input type="text"
               [(ngModel)]="newBooking.guestName"
               name="guestName"
               required />
      </div>

      <div class="form-group">
        <label>Email du client (guestEmail)</label>
        <input type="email"
               [(ngModel)]="newBooking.guestEmail"
               name="guestEmail"
               required />
      </div>

      <!-- üîµ Date d'arriv√©e AVEC Angular Material + filtre -->
      <div class="form-group">
        <label>Date d'arriv√©e (startDate)</label>
        <mat-form-field appearance="outline" class="full-width">
          <input
            matInput
            [matDatepicker]="pickerStart"
            [(ngModel)]="startDateModel"
            name="startDateModel"
            [matDatepickerFilter]="startDateFilter"
            required
          />
          <mat-datepicker-toggle matSuffix [for]="pickerStart"></mat-datepicker-toggle>
          <mat-datepicker #pickerStart></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- üîµ Date de d√©part AVEC Angular Material + filtre -->
      <div class="form-group">
        <label>Date de d√©part (endDate)</label>
        <mat-form-field appearance="outline" class="full-width">
          <input
            matInput
            [matDatepicker]="pickerEnd"
            [(ngModel)]="endDateModel"
            name="endDateModel"
            [matDatepickerFilter]="endDateFilter"
            required
          />
          <mat-datepicker-toggle matSuffix [for]="pickerEnd"></mat-datepicker-toggle>
          <mat-datepicker #pickerEnd></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="form-group">
        <label>Prix total (totalPrice)</label>
        <input type="number"
               [(ngModel)]="newBooking.totalPrice"
               name="totalPrice"
               min="0"
               step="0.01"
               required />
      </div>

      <div class="form-group">
        <label>Statut</label>
        <select [(ngModel)]="newBooking.status" name="status">
          <option value="PENDING">PENDING</option>
          <option value="CONFIRMED">CONFIRMED</option>
          <option value="CANCELED">CANCELED</option>
        </select>
      </div>

      <button type="submit">Cr√©er la r√©servation</button>
    </form>

  </div>

  <!-- Liste -->
  <div class="card">
    <h2>Liste des r√©servations</h2>

    <div *ngIf="loading">Chargement...</div>

    <table *ngIf="!loading && filteredBookings.length > 0">
      <thead>
      <tr>
        <th>#</th>
        <th>Logement</th>
        <th>Client</th>
        <th>Email</th>
        <th>Arriv√©e</th>
        <th>D√©part</th>
        <th>Nuits</th>
        <th>Prix total</th>
        <th>Prix/nuit</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let b of filteredBookings">
        <td>{{ b.id }}</td>
        <td>{{ b.propertyId }}</td>
        <td>{{ b.guestName }}</td>
        <td>{{ b.guestEmail }}</td>

        <td>
          {{ b.startDate | date:'dd/MM/yyyy' }}
          <span *ngIf="isToday(b.startDate)" class="badge-today">
            AUJOURD'HUI
          </span>
        </td>
        <td>{{ b.endDate | date:'dd/MM/yyyy' }}</td>
        <td>{{ getNights(b) }}</td>
        <td>
          {{ formatAmount(b.totalPrice) }} ‚Ç¨
        </td>
        <td>
          <ng-container *ngIf="getPricePerNight(b) as p; else noPrice">
            {{ formatPricePerNight(p) }} ‚Ç¨
          </ng-container>
          <ng-template #noPrice>-</ng-template>
        </td>
        <td>
          <span [ngClass]="getStatusClass(b.status)">
            {{ b.status }}
          </span>
        </td>
        <td>
          <button
            type="button"
            class="btn-cancel"
            (click)="cancelBooking(b)"
            [disabled]="b.status === 'CANCELED'">
            {{ b.status === 'CANCELED' ? 'Annul√©' : 'Annuler' }}
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <!-- cas : la base a des r√©servations mais les filtres les cachent toutes -->
    <div *ngIf="!loading
            && bookings.length > 0
            && filteredBookings.length === 0">
      Aucune r√©servation ne correspond √† ces filtres.
    </div>

    <!-- cas : vraiment aucune r√©servation en base -->
    <div *ngIf="!loading && bookings.length === 0">
      Aucune r√©servation pour l‚Äôinstant.
    </div>
  </div>
</div>
